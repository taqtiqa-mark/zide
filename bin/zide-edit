#!/usr/bin/env bash

paths=("$@")

# Ensure paths with special chars (like spaces) are properly escaped
escaped_paths=()
for p in "${paths[@]}"; do
  escaped_paths+=("$(printf "%q" "$p")")
done
# Use original first path for checks to avoid issues with escaped strings
path="${paths[0]}"
escaped_path=${escaped_paths[0]}

# Focus editor pane, must be the next pane after yazi
zellij action focus-next-pane
#zellij action move-focus left

# If we're trying to open a single path and it's a directory, change the working dir to it in our
# editor. This ensures any other commands in our editor (such as :open, :mv, etc) have the correct
# cwd set.
if [ -d "${path}" ] && [ ${#paths[@]} -eq 1 ]; then
	zellij action write 27 # send <Escape> key to enter NORMAL mode
	zellij action write-chars ":cd ${escaped_path}"
	zellij action write 13 # send <Enter> key

	# Zellij requires time to `write-chars`. @josephschmitt (GitHub) found length divided by
	# 150 is sufficient time.
	sleep $(echo "${#escaped_path} / 150" | bc -l)
fi

# Open paths in the editor
if [[ -n "${escaped_paths}" ]]; then
	zellij action write 27 # send <Escape> key to enter NORMAL mode
	zellij action write-chars ":open ${escaped_paths[*]}"
	zellij action write 13 # send <Enter> key
fi
