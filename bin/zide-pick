#!/usr/bin/env bash

# If no paths are selected but CWD has changed, issue :cd to the new CWD.
# If a single directory is selected, :cd to it.
# Otherwise, :open the paths (suitable for files or multiple items).

export YAZI_CONFIG_HOME="${ZIDE_CONFIG_DIR}/yazi"

# Ensure PATH includes Snap binaries and clear command hash for fresh resolution.
export PATH="$PATH:/snap/bin"
hash -r

# Input directory from argument (e.g., "$1" as starting dir).
input_dir="${1:-${HOME}}"

# Create temporary files for Yazi outputs to avoid stdout conflicts.
chooser_file=$(mktemp /tmp/yazi-chooser.XXXXXX) || { echo "Error: Failed to create temp chooser file." >&2; exit 1; }
cwd_file=$(mktemp /tmp/yazi-cwd.XXXXXX) || { echo "Error: Failed to create temp cwd file." >&2; exit 1; }

# Run Yazi, capturing selected paths and final CWD separately.
yazi "$input_dir" --chooser-file="$chooser_file" --cwd-file="$cwd_file"
yazi_exit_code=$?

# Clean up temp files on exit.
trap 'rm -f "$chooser_file" "$cwd_file"' EXIT

# Check for Yazi execution failure.
if [ $yazi_exit_code -ne 0 ]; then
    echo "Error: Yazi exited with code $yazi_exit_code." >&2
    zellij action toggle-floating-panes
    exit 1
fi

# Read selected paths into an array (unescaped for checks).
mapfile -t paths < "$chooser_file"

# Read final CWD (unescaped).
new_cwd=$(cat "$cwd_file" | xargs)  # Trim any whitespace.

# Escape paths for safe insertion into Helix commands.
escaped_paths=()
for path in "${paths[@]}"; do
    escaped_paths+=("$(printf "%q" "$path")")
done

# Toggle floating panes regardless (as in original).
zellij action move-focus down

# Case 1: No selections, but CWD changed -> :cd to new CWD.
if [ ${#paths[@]} -eq 0 ] && [ "$new_cwd" != "$input_dir" ] && [ -d "$new_cwd" ]; then
    escaped_cwd=$(printf "%q" "$new_cwd")
    zellij action write 27  # Send <Escape> to enter normal mode.
    zellij action write-chars ":cd $escaped_cwd"
    zellij action write 13  # Send <Enter>.
    sleep 0.1s  # Brief delay for command processing.
    exit 0
fi

# Case 2: Single path and it's a directory -> :cd to it.
if [ ${#paths[@]} -eq 1 ] && [ -d "${paths[0]}" ]; then
    zellij action write 27  # Send <Escape>.
    zellij action write-chars ":cd ${escaped_paths[0]}"
    zellij action write 13  # Send <Enter>.
    sleep 0.1s
    exit 0
fi

# Case 3: Paths present (files or multiple) -> :open them.
if [ ${#paths[@]} -gt 0 ]; then
    zellij action write 27  # Send <Escape>.
    zellij action write-chars ":open ${escaped_paths[*]}"
    zellij action write 13  # Send <Enter>.
    sleep 0.1s
    exit 0
fi

# Fallback: No action needed if empty and CWD unchanged.

